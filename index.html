<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Appex Vibe Coder - Studio</title>
    
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="https://ik.imagekit.io/migbb/vibe-coding.png?updatedAt=1771554953655" type="image/png" sizes="200x200" />
    <meta name="theme-color" content="#0f172a">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://gateway.dhruvs.host/widget.js" defer></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen flex overflow-hidden">

    <div class="flex w-full h-full">

        <div class="w-[30%] min-w-[300px] flex flex-col border-r border-slate-800 bg-slate-950">
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="flex flex-col items-start">
                    <div class="flex items-center gap-2 text-purple-400 mb-1">
                        <span class="font-semibold text-sm">Appex Agent</span>
                    </div>
                    <div class="p-3 rounded-2xl rounded-tl-none bg-slate-800/50 border border-slate-700 shadow-sm text-sm text-slate-300">
                        Ready to vibe code. Describe what you want, and I'll generate the files.
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-800 bg-slate-900">
                <div class="relative flex">
                    <textarea id="prompt-input" rows="1" placeholder="e.g., Build a modern login screen" 
                        class="w-full bg-slate-800 border border-slate-700 focus:border-blue-500 rounded-xl px-4 py-3 pr-12 outline-none resize-none shadow-sm transition-all text-slate-200 placeholder-slate-500"></textarea>
                    <button onclick="sendToAI()" class="absolute right-2 bottom-2 p-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-transform active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="w-[18%] min-w-[150px] flex flex-col bg-black border-r border-slate-800">
            <div class="p-3 border-b border-slate-800 flex items-center justify-between">
                <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Workspace</span>
            </div>
            
            <div id="file-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                <div class="text-xs text-slate-600 italic p-2 text-center mt-4">No files generated yet.</div>
            </div>
        </div>

        <div class="flex-1 flex flex-col bg-[#0d1117] relative">
            
            <div class="flex items-center justify-between p-3 border-b border-slate-800 bg-[#161b22]">
                <div class="flex items-center gap-4">
                    <div id="file-name-display" class="font-mono text-sm font-semibold text-slate-300">
                        Waiting for files...
                    </div>
                    
                    <div id="view-toggles" class="hidden flex bg-slate-900 rounded-lg p-1 border border-slate-700">
                        <button id="btn-code" onclick="toggleView('code')" class="px-3 py-1 text-sm rounded-md bg-slate-700 text-white font-medium transition">Code</button>
                        <button id="btn-preview" onclick="toggleView('preview')" class="px-3 py-1 text-sm rounded-md text-slate-400 hover:text-white transition">Preview</button>
                    </div>
                </div>

                <button onclick="downloadCode()" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 text-white px-3 py-1.5 rounded-md text-sm transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Download
                </button>
            </div>
            
            <div class="flex-1 relative overflow-auto p-4">
                <pre id="code-container" class="m-0 h-full"><code id="code-display" class="language-html text-sm font-mono h-full block text-slate-500">/* Generated code will appear here */</code></pre>
                <iframe id="preview-frame" class="w-full h-full bg-white rounded-md hidden border-none" sandbox="allow-scripts allow-forms allow-same-origin allow-modals"></iframe>
            </div>
        </div>

    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const inputField = document.getElementById('prompt-input');
        
        const fileListContainer = document.getElementById('file-list');
        const fileNameDisplay = document.getElementById('file-name-display');
        
        const codeDisplay = document.getElementById('code-display');
        const codeContainer = document.getElementById('code-container');
        
        const previewFrame = document.getElementById('preview-frame');
        const viewToggles = document.getElementById('view-toggles');
        const btnCode = document.getElementById('btn-code');
        const btnPreview = document.getElementById('btn-preview');

        let files = {}; 
        let currentActiveFile = null;

        // Auto-resize textarea
        inputField.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });

        // Enter to send
        inputField.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendToAI();
            }
        });

        function appendMessage(role, text) {
            const isUser = role === 'user';
            
            let chatText = typeof text === 'string' ? text : JSON.stringify(text);
            if (!isUser) {
                chatText = chatText.replace(/\((.*?)\)\s*([\s\S]*?)--end/gi, '\n[File generated: $1]\n');
                chatText = chatText.replace(/```[\s\S]*?```/gi, '\n[Code generated in panel]\n');
            }

            const html = `
                <div class="flex flex-col ${isUser ? 'items-end' : 'items-start'}">
                    <div class="flex items-center gap-2 mb-1 ${isUser ? 'text-blue-400 flex-row-reverse' : 'text-purple-400'}">
                        <span class="font-semibold text-sm">${isUser ? 'You' : 'Appex Agent'}</span>
                    </div>
                    <div class="p-3 rounded-2xl ${isUser ? 'bg-blue-600/10 border-blue-500/30 rounded-tr-none text-slate-200' : 'bg-slate-800/50 border-slate-700 rounded-tl-none text-slate-300'} shadow-sm text-sm whitespace-pre-wrap">${chatText.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
                </div>
            `;
            chatContainer.insertAdjacentHTML('beforeend', html);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function toggleView(view) {
            if (view === 'preview') {
                codeContainer.classList.add('hidden');
                previewFrame.classList.remove('hidden');
                if(files[currentActiveFile]) previewFrame.srcdoc = files[currentActiveFile].code;
                
                btnPreview.classList.add('bg-slate-700', 'text-white');
                btnPreview.classList.remove('text-slate-400');
                btnCode.classList.remove('bg-slate-700', 'text-white');
                btnCode.classList.add('text-slate-400');
            } else {
                previewFrame.classList.add('hidden');
                codeContainer.classList.remove('hidden');

                btnCode.classList.add('bg-slate-700', 'text-white');
                btnCode.classList.remove('text-slate-400');
                btnPreview.classList.remove('bg-slate-700', 'text-white');
                btnPreview.classList.add('text-slate-400');
            }
        }

        function renderFileList() {
            if(!fileListContainer) return;
            
            fileListContainer.innerHTML = '';
            const fileNames = Object.keys(files);
            
            if(fileNames.length === 0) {
                fileListContainer.innerHTML = `<div class="text-xs text-slate-600 italic p-2 text-center mt-4">No files generated yet.</div>`;
                return;
            }

            fileNames.forEach(fileName => {
                const isActive = fileName === currentActiveFile;
                const baseClasses = "block w-full text-left px-3 py-2 rounded-md text-sm font-mono truncate transition-all cursor-pointer";
                const activeClasses = "bg-yellow-400 text-black font-semibold shadow-sm";
                const inactiveClasses = "text-slate-400 hover:bg-slate-800 hover:text-slate-200";

                const btn = document.createElement('button');
                btn.className = `${baseClasses} ${isActive ? activeClasses : inactiveClasses}`;
                btn.textContent = fileName;
                btn.onclick = () => switchFile(fileName);
                
                fileListContainer.appendChild(btn);
            });
        }

        function switchFile(fileName) {
            currentActiveFile = fileName;
            renderFileList(); 
            
            const fileData = files[fileName];
            if(!fileData) return;

            fileNameDisplay.textContent = fileName;

            codeDisplay.removeAttribute('data-highlighted');
            codeDisplay.className = `language-${fileData.lang} text-sm font-mono h-full block`;
            codeDisplay.textContent = fileData.code;
            hljs.highlightElement(codeDisplay);

            if (fileData.lang === 'html') {
                viewToggles.classList.remove('hidden');
                toggleView('preview'); 
            } else {
                viewToggles.classList.add('hidden');
                toggleView('code'); 
            }
        }

        function processAIResponse(rawText) {
            const text = typeof rawText === 'string' ? rawText : JSON.stringify(rawText, null, 2);
            let foundFiles = false;

            // Strategy A: Custom format
            const strictRegex = /\((.*?)\)\s*([\s\S]*?)--end/gi;
            let match;
            while ((match = strictRegex.exec(text)) !== null) {
                foundFiles = true;
                const fileName = match[1].trim() || `file_${Date.now()}.js`;
                const codeContent = match[2].trim();
                const ext = fileName.split('.').pop().toLowerCase();
                const lang = ext === 'js' ? 'javascript' : ext === 'html' ? 'html' : ext === 'css' ? 'css' : ext === 'json' ? 'json' : 'txt';

                files[fileName] = { code: codeContent, lang: lang };
                if(!currentActiveFile) currentActiveFile = fileName;
            }

            // Strategy B: Fallback Markdown
            if (!foundFiles) {
                const mdRegex = /```(\w+)?\n([\s\S]*?)```/gi;
                let mdMatch;
                let counter = 1;
                while ((mdMatch = mdRegex.exec(text)) !== null) {
                    foundFiles = true;
                    const lang = (mdMatch[1] || 'html').toLowerCase();
                    const ext = lang === 'javascript' ? 'js' : lang;
                    const fileName = `generated_${counter}.${ext}`;
                    
                    files[fileName] = { code: mdMatch[2].trim(), lang: lang };
                    if(!currentActiveFile) currentActiveFile = fileName;
                    counter++;
                }
            }

            // Strategy C: Nuclear Fallback
            if (!foundFiles && text.trim().length > 0) {
                files["app.html"] = { code: text.trim(), lang: 'html' };
                currentActiveFile = "app.html";
            }

            renderFileList();
            if (currentActiveFile) switchFile(currentActiveFile);
        }

        function downloadCode() {
            if (!currentActiveFile || !files[currentActiveFile]) return;
            const fileData = files[currentActiveFile];
            const blob = new Blob([fileData.code], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = currentActiveFile;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        async function sendToAI() {
            const prompt = inputField.value.trim();
            if (!prompt) return;

            inputField.value = '';
            inputField.style.height = 'auto';
            appendMessage('user', prompt);

            const loadingId = 'loading-' + Date.now();
            chatContainer.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="flex flex-col items-start animate-pulse"><div class="p-3 rounded-2xl rounded-tl-none bg-slate-800/50 border border-slate-700 shadow-sm text-sm text-slate-500">Generating code...</div></div>`);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            if(fileListContainer) {
                fileListContainer.innerHTML = `<div class="text-xs text-yellow-400 italic p-2 text-center mt-4 animate-pulse">Building files...</div>`;
            }

            try {
                if (typeof window.dhruvs !== "function") throw new Error("Gateway script not loaded.");

                const reply = await window.dhruvs("gateway-call", prompt, "google/gemini-3.0-pro", true);
                
                document.getElementById(loadingId).remove();
                
                processAIResponse(reply);
                appendMessage('ai', reply);

            } catch (err) {
                document.getElementById(loadingId).remove();
                appendMessage('ai', `⚠️ Error: ${err.message}`);
                renderFileList(); 
            }
        }
    </script>
</body>
</html>
