<script>
        const chatContainer = document.getElementById('chat-container');
        const inputField = document.getElementById('prompt-input');
        
        const codeDisplay = document.getElementById('code-display');
        const codeContainer = document.getElementById('code-container');
        const fileNameDisplay = document.getElementById('file-name');
        
        const previewFrame = document.getElementById('preview-frame');
        const viewToggles = document.getElementById('view-toggles');
        const btnCode = document.getElementById('btn-code');
        const btnPreview = document.getElementById('btn-preview');

        let currentCode = "";
        let currentLanguage = "html";

        // Auto-resize textarea
        inputField.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });

        // Allow 'Enter' to send, 'Shift+Enter' for new line
        inputField.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendToAI();
            }
        });

        function appendMessage(role, text) {
            const isUser = role === 'user';
            // Simple clean up to remove the code block from the chat UI so the chat looks cleaner
            let chatText = text;
            if (!isUser) {
                chatText = chatText.replace(/\((.*?)\)\s*([\s\S]*?)--end/gi, '[Code generated in panel]');
            }

            const html = `
                <div class="flex flex-col ${isUser ? 'items-end' : 'items-start'}">
                    <div class="flex items-center gap-2 mb-1 ${isUser ? 'text-blue-400 flex-row-reverse' : 'text-purple-400'}">
                        <span class="font-semibold text-sm">${isUser ? 'You' : 'Appex Agent'}</span>
                    </div>
                    <div class="p-3 rounded-2xl ${isUser ? 'bg-blue-600/10 border-blue-500/30 rounded-tr-none text-slate-200' : 'bg-slate-800/50 border-slate-700 rounded-tl-none text-slate-300'} shadow-sm text-sm whitespace-pre-wrap">${chatText.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
                </div>
            `;
            chatContainer.insertAdjacentHTML('beforeend', html);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function toggleView(view) {
            if (view === 'preview') {
                codeContainer.classList.add('hidden');
                previewFrame.classList.remove('hidden');
                previewFrame.srcdoc = currentCode;

                btnPreview.classList.add('bg-slate-700', 'text-white', 'font-medium');
                btnPreview.classList.remove('text-slate-400');
                btnCode.classList.remove('bg-slate-700', 'text-white', 'font-medium');
                btnCode.classList.add('text-slate-400');
            } else {
                previewFrame.classList.add('hidden');
                codeContainer.classList.remove('hidden');

                btnCode.classList.add('bg-slate-700', 'text-white', 'font-medium');
                btnCode.classList.remove('text-slate-400');
                btnPreview.classList.remove('bg-slate-700', 'text-white', 'font-medium');
                btnPreview.classList.add('text-slate-400');
            }
        }

        function updateCodeDisplay(text) {
            // CUSTOM PARSER: Looks for (filename.ext) ... --end
            const regex = /\((.*?)\)\s*([\s\S]*?)--end/i;
            const match = text.match(regex);

            if (match && match.length >= 3) {
                const fileName = match[1].trim();
                currentCode = match[2].trim();
                
                // Determine language based on the file extension the AI provided
                const ext = fileName.split('.').pop().toLowerCase();
                currentLanguage = ext === 'js' ? 'javascript' : 
                                  ext === 'html' ? 'html' : 
                                  ext === 'css' ? 'css' : 
                                  ext === 'json' ? 'json' : 'txt';
                
                fileNameDisplay.textContent = fileName;
            } else {
                // FALLBACK: If the AI messes up the format
                console.log("Custom format not found, using raw text fallback.");
                currentCode = text.trim();
                currentLanguage = 'html'; 
                fileNameDisplay.textContent = 'index.html';
            }

            // Force reset Highlight.js
            codeDisplay.removeAttribute('data-highlighted');

            // Update code block UI
            codeDisplay.className = `language-${currentLanguage} text-sm font-mono h-full block`;
            codeDisplay.textContent = currentCode;
            hljs.highlightElement(codeDisplay);

            // Toggle logic: Only show preview button if it's HTML
            if (currentLanguage === 'html') {
                viewToggles.classList.remove('hidden');
                toggleView('preview');
            } else {
                viewToggles.classList.add('hidden');
                toggleView('code'); 
            }
        }

        function downloadCode() {
            if (!currentCode) return;
            const blob = new Blob([currentCode], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = fileNameDisplay.textContent;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        async function sendToAI() {
            const prompt = inputField.value.trim();
            if (!prompt) return;

            inputField.value = '';
            inputField.style.height = 'auto';
            appendMessage('user', prompt);

            const loadingId = 'loading-' + Date.now();
            chatContainer.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="flex flex-col items-start animate-pulse"><div class="p-3 rounded-2xl rounded-tl-none bg-slate-800/50 border border-slate-700 shadow-sm text-sm text-slate-500">Generating code...</div></div>`);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                if (typeof window.dhruvs !== "function") {
                    throw new Error("Gateway script not loaded or blocked.");
                }

                const reply = await window.dhruvs(
                    "gateway-call", 
                    prompt, 
                    "google/gemini-3.0-pro",
                    true 
                );
                
                document.getElementById(loadingId).remove();
                
                // Update the code panel
                updateCodeDisplay(reply);
                
                // Append the chat message (the appendMessage function will now strip out the ugly code block from the chat UI)
                appendMessage('ai', reply);

            } catch (err) {
                document.getElementById(loadingId).remove();
                appendMessage('ai', `⚠️ Error: ${err.message}.`);
            }
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js');
            });
        }
    </script>
